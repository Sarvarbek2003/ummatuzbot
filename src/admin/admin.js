const {selectAudios, update, insert, select, } = require('../util.js')
const { videocategory, date ,category, send, adminmenu,updateMenu } = require('../menu.js')

const audiosAdmin = require('../admin/audios.js')
const videosAdmin = require('../admin/videos.js')

let year = ''
let habar = ''
let photo = ''
let forId = 0
module.exports = async(bot, msg) => {
    let chatId = msg.chat.id
    let text = msg.text
    let audios = await selectAudios()
    let steep = (await select()).find(user => user.user_id == chatId)?.steep.split(' ')
    let st = steep[steep.length - 1]
    if(text == 'üéô –ê—É–¥–∏–æ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä'){
        if (steep[steep.length - 1] != 'adminAudio') steep.push('adminAudio'), await update(chatId, steep)
            bot.sendMessage(chatId, '–ê—É–¥–∏–æ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä',{
                reply_markup: category
            })
    }
    else if(text == 'üé• –í–∏–¥–µ–æ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä' && st == 'admin'){
        if (steep[steep.length - 1] != 'adminVideo') steep.push('adminVideo'), await update(chatId, steep)
        bot.sendMessage(chatId, '–í–∏–¥–µ–æ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä',{
                reply_markup: videocategory
            })
    }
    else if(text == '‚ÅâÔ∏è –°–∞–≤–æ–ª-–∂–∞–≤–æ–±'){
        if (steep[steep.length - 1] != 'adminJavob') steep.push('adminJavob'), await update(chatId, steep)
            bot.sendMessage(chatId, '–°–∞–≤–æ–ª-–∂–∞–≤–æ–±',{
                reply_markup: category
            })
    }
    else if(text == '‚ùì –°–∞–≤–æ–ª –±–µ—Ä–∏—à'){
        if (steep[steep.length - 1] != 'adminSavol') steep.push('adminSavol'), await update(chatId, steep)
            bot.sendMessage(chatId, '–°–∞–≤–æ–ª-–∂–∞–≤–æ–±',{
                reply_markup: category
            })
    }
    else if(text == 'üì® –•–∞–±–∞—Ä —é–±–æ—Ä–∏—à'){
        if (steep[steep.length - 1] != 'send') steep.push('send'), await update(chatId, steep)
            bot.sendMessage(chatId, '“ö–∞–Ω–¥–∞–π —Ç—É—Ä–¥–∞–≥–∏ “≥–∞–±–∞—Ä–Ω–∏ —é–±–æ—Ä–º–æ“õ—á–∏—Å–∏–∑?',{
                reply_markup: send
            })
    }
    else if(text == 'üì© –§–æ—Äw–∞—Ä–¥ —Ö–∞–±–∞—Ä'){
        if (steep[steep.length - 1] != 'forsend') steep.push('forsend'), await update(chatId, steep)
            bot.sendMessage(chatId, '–§–æ—Äw–∞—Ä–¥ “≥–∞–±–∞—Ä–Ω–∏ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: {
                    resize_keyboard: true,
                    keyboard: [
                        [{text: 'üîô –û—Ä—Ç–≥–∞'}]
                    ]
                }
            })
    }
    else if(text == 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'){
        if (steep[steep.length - 1] != 'stat') steep.push('stat'), await update(chatId, steep)
            bot.sendMessage(chatId, '–°–∞–≤–æ–ª-–∂–∞–≤–æ–±',{
                reply_markup: category
            })
    }
    else if(text == '‚öôÔ∏è –°–æ–∑–ª–∞–º–∞–ª–∞—Ä'){
        if (steep[steep.length - 1] != 'settings') steep.push('settings'), await update(chatId, steep)
            bot.sendMessage(chatId, '–°–∞–≤–æ–ª-–∂–∞–≤–æ–±',{
                reply_markup: category
            })
    }
    else if((st == 'adminJuma' || st == 'adminMaruza' || st == 'sendFoydali' || st == 'ramazon') && text == 'üîô –û—Ä—Ç–≥–∞'){
        steep.splice(steep.length-1, 1)
        await menu(bot,steep,chatId)
        await update(chatId, steep)
    }
    else if(st == 'adminAudio'){
        if((st == 'adminJuma' || st == 'adminMaruza' ||  st == 'adminAudio' || st == 'ramazon') && text == 'üîô –û—Ä—Ç–≥–∞'){
            steep.splice(steep.length-1, 1)
            await menu(bot,steep,chatId)
            await update(chatId, steep)
        }
        if (text == 'üïã –ñ—É–º–∞ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä'){
            if (steep[steep.length - 1] != 'adminJuma') steep.push('adminJuma'), await update(chatId, steep)
            bot.sendMessage(chatId, '–ñ—É–º–∞ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä',{
                reply_markup: date
            })
        }
        else if(text == 'üéô “ö–∏—Å“õ–∞ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä'){
            if (steep[steep.length - 1] != 'adminMaruza') steep.push('adminMaruza'), await update(chatId, steep)
            bot.sendMessage(chatId, '“ö–∏—Å“õ–∞ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä',{
                reply_markup: date
            })
        }
        else if(text == 'üìñ –ò–ª–º–∏–π —Å—É“≥–±–∞—Ç'){
            if (steep[steep.length - 1] != 'sendIlmiy') steep.push('sendIlmiy'), await update(chatId, steep)
            let categ = render(audios,3)
            bot.sendMessage(chatId, '–ò–ª–º–∏–π —Å—É“≥–±–∞—Ç –∞—É–¥–∏–æ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: {
                    resize_keyboard:true,
                    keyboard: categ
                }
            })
        }
        else if(text == 'üóÇ –§–æ–π–¥–∞–ª–∏ –¥–∞—Ä—Å–ª–∞—Ä'){
            if (steep[steep.length - 1] != 'adminFoydali') steep.push('adminFoydali'), await update(chatId, steep)
            bot.sendMessage(chatId, '–§–æ–π–¥–∞–ª–∏ –¥–∞—Ä—Å–ª–∞—Ä–Ω–∏ “õ—û—à–∏—à —É—á—É–Ω –ø–ª–∞–π–ª–∏—Å—Ç –ª–∏–Ω–∫–∏–Ω–∏ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: updateMenu
            })
        }
        else if(text == 'üí´ –†–∞–º–∞–∑–æ–Ω —Å—É—Ö–±–∞—Ç–ª–∞—Ä–∏'){
            if (steep[steep.length - 1] != 'ramazon') steep.push('ramazon'), await update(chatId, steep)
            bot.sendMessage(chatId, '–†–∞–º–∞–∑–æ–Ω —Å—É—Ö–±–∞—Ç–ª–∞—Ä–∏',{
                resize_keyboard:true,
                reply_markup: date
            })
        }
    }
    else if(st == 'adminJuma' || steep[4] == 'sendAudio'){
        if (!steep.includes('sendAudio')) steep.push('sendAudio'), await update(chatId, steep), year = msg.text
        audiosAdmin.juma(bot,msg,year)
    }
    else if(st == 'adminMaruza' || steep[4] == 'sendMaruza'){
        if (!steep.includes('sendMaruza')) steep.push('sendMaruza'), await update(chatId, steep), year = msg.text
        audiosAdmin.maruza(bot,msg,year)
    }
    else if(st == 'sendIlmiy' || steep[4] == 'sendTitle'){
        if (!steep.includes('sendIlmiy')) steep.push('sendIlmiy'), await update(chatId, steep)
        audiosAdmin.ilmiy(bot,msg)
    }
    else if(st == 'ramazon' || steep[4] == 'sendRamazon'){
        
        if (!steep.includes('sendRamazon')) steep.push('sendRamazon'), await update(chatId, steep), year = msg.text
        audiosAdmin.ramazon(bot,msg,year)
    }
    else if(st == 'adminFoydali' || steep[4] == 'sendFoydali'){
        if(
            !(text.startsWith('https://www.youtube.com/watch?v=') && text.split('=')[2]) &&  
            !(text.startsWith('https://youtube.com/playlist?list=') && text.split('=')[1]) 
        ){
            if(text != "‚ôªÔ∏è –Ø–Ω–≥–∏–ª–∞—à" && text != "‚ùå –é—á–∏—Ä–∏—à") return bot.sendMessage(chatId, "–ù–æ—Ç—û–≥—Ä–∏ –ª–∏–Ω–∫ —é–±–æ—Ä–¥–∏–Ω–≥–∏–∑\n–ª–∏–Ω–∫–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–± “õ–∞–π—Ç–∞ —é–±–æ—Ä–∏–Ω–≥")
        }  

        audiosAdmin.foydali(bot,msg)
    }
    else if((st == 'adminVideo' || st == 'videoJuma' || st == 'videoMaruza' || st == 'videoIlmiy' || st == 'videoSavol') && text == 'üîô –û—Ä—Ç–≥–∞'){
        steep.splice(steep.length-1, 1)
        await menu(bot,steep,chatId)
        await update(chatId, steep)
    }
    else if(st == 'adminVideo'){
        if (text == 'üïã –ñ—É–º–∞ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä'){
            if (steep[steep.length - 1] != 'videoJuma') steep.push('videoJuma'), await update(chatId, steep)
            bot.sendMessage(chatId, '–§–æ–π–¥–∞–ª–∏ –¥–∞—Ä—Å–ª–∞—Ä–Ω–∏ “õ—û—à–∏—à —É—á—É–Ω –ø–ª–∞–π–ª–∏—Å—Ç –ª–∏–Ω–∫–∏–Ω–∏ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: updateMenu
            })
        }
        else if(text == 'üéô “ö–∏—Å“õ–∞ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä'){
            if (steep[steep.length - 1] != 'videoMaruza') steep.push('videoMaruza'), await update(chatId, steep)
            bot.sendMessage(chatId, '–§–æ–π–¥–∞–ª–∏ –¥–∞—Ä—Å–ª–∞—Ä–Ω–∏ “õ—û—à–∏—à —É—á—É–Ω –ø–ª–∞–π–ª–∏—Å—Ç –ª–∏–Ω–∫–∏–Ω–∏ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: updateMenu
            })
        }
        else if(text == 'üìñ –ò–ª–º–∏–π —Å—É“≥–±–∞—Ç'){
            if (steep[steep.length - 1] != 'videoIlmiy') steep.push('videoIlmiy'), await update(chatId, steep)
            let categ = render(audios,3)
            bot.sendMessage(chatId, '–§–æ–π–¥–∞–ª–∏ –¥–∞—Ä—Å–ª–∞—Ä–Ω–∏ “õ—û—à–∏—à —É—á—É–Ω –ø–ª–∞–π–ª–∏—Å—Ç –ª–∏–Ω–∫–∏–Ω–∏ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: updateMenu
            })
        }
        else if(text == '‚ÅâÔ∏è –°–∞–≤–æ–ª-–∂–∞–≤–æ–±–ª–∞—Ä'){
            if (steep[steep.length - 1] != 'videoSavol') steep.push('videoSavol'), await update(chatId, steep)
            bot.sendMessage(chatId, '–§–æ–π–¥–∞–ª–∏ –¥–∞—Ä—Å–ª–∞—Ä–Ω–∏ “õ—û—à–∏—à —É—á—É–Ω –ø–ª–∞–π–ª–∏—Å—Ç –ª–∏–Ω–∫–∏–Ω–∏ —é–±–æ—Ä–∏–Ω–≥',{
                reply_markup: updateMenu
            })
        } 
    }
    else if(st == 'videoJuma'){
        if(
            !(text.startsWith('https://www.youtube.com/watch?v=') && text.split('=')[2]) &&  
            !(text.startsWith('https://youtube.com/playlist?list=') && text.split('=')[1]) 
        ){
            if(text != "‚ôªÔ∏è –Ø–Ω–≥–∏–ª–∞—à" && text != "‚ùå –é—á–∏—Ä–∏—à") return bot.sendMessage(chatId, "–ù–æ—Ç—û–≥—Ä–∏ –ª–∏–Ω–∫ —é–±–æ—Ä–¥–∏–Ω–≥–∏–∑\n–ª–∏–Ω–∫–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–± “õ–∞–π—Ç–∞ —é–±–æ—Ä–∏–Ω–≥")
        } 
        videosAdmin.juma(bot, msg)
    }
    else if(st == 'videoMaruza'){
        if(
            !(text.startsWith('https://www.youtube.com/watch?v=') && text.split('=')[2]) &&  
            !(text.startsWith('https://youtube.com/playlist?list=') && text.split('=')[1]) 
        ){
            if(text != "‚ôªÔ∏è –Ø–Ω–≥–∏–ª–∞—à" && text != "‚ùå –é—á–∏—Ä–∏—à") return bot.sendMessage(chatId, "–ù–æ—Ç—û–≥—Ä–∏ –ª–∏–Ω–∫ —é–±–æ—Ä–¥–∏–Ω–≥–∏–∑\n–ª–∏–Ω–∫–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–± “õ–∞–π—Ç–∞ —é–±–æ—Ä–∏–Ω–≥")
        } 
        videosAdmin.maruza(bot, msg)
    }
    else if(st == 'videoIlmiy'){
        if(
            !(text.startsWith('https://www.youtube.com/watch?v=') && text.split('=')[2]) &&  
            !(text.startsWith('https://youtube.com/playlist?list=') && text.split('=')[1]) 
        ){
            if(text != "‚ôªÔ∏è –Ø–Ω–≥–∏–ª–∞—à" && text != "‚ùå –é—á–∏—Ä–∏—à") return bot.sendMessage(chatId, "–ù–æ—Ç—û–≥—Ä–∏ –ª–∏–Ω–∫ —é–±–æ—Ä–¥–∏–Ω–≥–∏–∑\n–ª–∏–Ω–∫–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–± “õ–∞–π—Ç–∞ —é–±–æ—Ä–∏–Ω–≥")
        } 
        videosAdmin.ilmiy(bot, msg)
    }
    else if(st == 'videoSavol'){
        if(
            !(text.startsWith('https://www.youtube.com/watch?v=') && text.split('=')[2]) &&  
            !(text.startsWith('https://youtube.com/playlist?list=') && text.split('=')[1]) 
        ){
            if(text != "‚ôªÔ∏è –Ø–Ω–≥–∏–ª–∞—à" && text != "‚ùå –é—á–∏—Ä–∏—à") return bot.sendMessage(chatId, "–ù–æ—Ç—û–≥—Ä–∏ –ª–∏–Ω–∫ —é–±–æ—Ä–¥–∏–Ω–≥–∏–∑\n–ª–∏–Ω–∫–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–± “õ–∞–π—Ç–∞ —é–±–æ—Ä–∏–Ω–≥")
        } 
        videosAdmin.savol(bot, msg)
    }
    else if (st == 'send' || st == 'sendText' || st == 'sendPhoto' || st == 'sendcaption'){
        if (text == 'üí¨ –ú–∞—Ç–Ω–ª–∏ “≥–∞–±–∞—Ä'){
            if (steep[steep.length - 1] != 'sendText') steep.push('sendText'), await update(chatId, steep)
            bot.sendMessage(chatId, "–Æ–±–æ—Ä–º–æ“õ—á–∏ –±—û–ª–≥–∞–Ω “≥–∞–±–∞—Ä–∏–Ω–≥–∏–∑ –º–∞—Ç–Ω–∏–Ω–∏ –∫–∏—Ä–∏—Ç–∏–Ω–≥")
        }
        else if(text == 'üñº –†–∞—Å–º–ª–∏ “≥–∞–±–∞—Ä'){
            if (steep[steep.length - 1] != 'sendPhoto') steep.push('sendPhoto'), await update(chatId, steep)
            bot.sendMessage(chatId, "–Æ–±–æ—Ä–º–æ“õ—á–∏ –±—û–ª–≥–∞–Ω “≥–∞–±–∞—Ä–∏–Ω–≥–∏–∑ga —Ä–∞—Å–º —é–±–æ—Ä–∏–Ω–≥")
        }
        else if(st == 'sendText'){
            if(text == '‚úÖ –¢–∞—Å–¥–∏“õ–ª–∞—à'){
                let users = await select()
                let ok = await users.map(user => {
                    bot.sendMessage(user.user_id, habar)
                    return true
                })
                if(ok) {
                    bot.sendMessage(chatId, '“≤–∞–±–∞—Ä '+ok.length+' —Ç–∞ –æ–¥–∞–º–≥–∞ —é–±–æ—Ä–∏–ª–¥–∏',{reply_markup: adminmenu})
                    let index = steep.indexOf('admin')
                    steep.splice(index+1,)
                    await update(chatId, steep)
                }else bot.sendMessage(chatId, '—Ö–∞—Ç–æ')
            }
            else {
                bot.sendMessage(chatId, '–Æ–±–æ—Ä–º–æ“õ—á–∏ –±—û–ª–≥–∞–Ω “≥–∞–±–∞—Ä–∏–Ω–≥–≥–∏–∑–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–≥ —à—É –∑–∞“≥–æ—Ç–∏ —Ñ–æ–π–¥–∞–ª–∞–Ω—É–≤—á–∏–ª–∞—Ä–≥–∞ —é–±–æ—Ä–∏–ª–∞–¥–∏',{
                    reply_markup: {
                        resize_keyboard: true,
                        keyboard: [
                            [{text: '‚úÖ –¢–∞—Å–¥–∏“õ–ª–∞—à'}]
                        ]
                    }
                })
                habar = text
            }
        }
        else if(st == 'sendPhoto' || st == 'sendcaption'){
            if(text == '‚úÖ –¢–∞—Å–¥–∏“õ–ª–∞—à'){
                let users = await select()
                let ok = await users.map(user => {
                    bot.sendPhoto(user.user_id, photo,{
                        caption: habar
                    })
                    return true
                })
                if(ok[0]) {
                    bot.sendMessage(chatId, '“≤–∞–±–∞—Ä '+ok.length+' —Ç–∞ –æ–¥–∞–º–≥–∞ —é–±–æ—Ä–∏–ª–¥–∏',{reply_markup: adminmenu})
                    let index = steep.indexOf('admin')
                    steep.splice(index+1,)
                    await update(chatId, steep)
                }else bot.sendMessage(chatId, '—Ö–∞—Ç–æ')
            }
            else if (msg.photo) {
                photo = msg.photo[0].file_id
                if (steep[steep.length - 1] != 'sendcaption') steep.push('sendcaption'), await update(chatId, steep)
                bot.sendMessage(chatId, '–†–∞—Å–º–Ω–∏–Ω–≥ —Ç–∞–≥–∏–≥–∞ —ë–∑–∏–ª–∞–¥–∏–≥–∞–Ω —Ö–∞–±–∞—Ä –º–∞—Ç–Ω–∏–Ω–∏ –∫–∏—Ä–∏—Ç–∏–Ω–≥')
            }
            else {
                bot.sendMessage(chatId, '–Æ–±–æ—Ä–º–æ“õ—á–∏ –±—û–ª–≥–∞–Ω “≥–∞–±–∞—Ä–∏–Ω–≥–≥–∏–∑–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–≥ —à—É –∑–∞“≥–æ—Ç–∏ —Ñ–æ–π–¥–∞–ª–∞–Ω—É–≤—á–∏–ª–∞—Ä–≥–∞ —é–±–æ—Ä–∏–ª–∞–¥–∏',{
                    reply_markup: {
                        resize_keyboard: true,
                        keyboard: [
                            [{text: '‚úÖ –¢–∞—Å–¥–∏“õ–ª–∞—à'}]
                        ]
                    }
                })
                habar = text
            }
        }
    }
    else if(st == 'forsend'){
        if(text == '‚úÖ –¢–∞—Å–¥–∏“õ–ª–∞—à'){
            let users = await select()
            let ok = await users.map(user => {
                bot.forwardMessage(user.user_id, chatId, forId )
                return true
            })
            if(ok) {
                bot.sendMessage(chatId, '“≤–∞–±–∞—Ä '+ok.length+' —Ç–∞ –æ–¥–∞–º–≥–∞ —é–±–æ—Ä–∏–ª–¥–∏',{reply_markup: adminmenu})
                let index = steep.indexOf('admin')
                steep.splice(index+1,)
                await update(chatId, steep)
            }else bot.sendMessage(chatId, '—Ö–∞—Ç–æ')
        } else {
            bot.sendMessage(chatId, '–Æ–±–æ—Ä–º–æ“õ—á–∏ –±—û–ª–≥–∞–Ω “≥–∞–±–∞—Ä–∏–Ω–≥–≥–∏–∑–Ω–∏ —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–≥ —à—É –∑–∞“≥–æ—Ç–∏ —Ñ–æ–π–¥–∞–ª–∞–Ω—É–≤—á–∏–ª–∞—Ä–≥–∞ —é–±–æ—Ä–∏–ª–∞–¥–∏',{
                reply_markup: {
                    resize_keyboard: true,
                    keyboard: [
                        [{text: '‚úÖ –¢–∞—Å–¥–∏“õ–ª–∞—à'}]
                    ]
                }
            })
            forId = msg?.message_id || 0
        }         
    }
}




    
const menu = (bot,steep,chatId) => {
    if(['adminIlmiy','adminAudio','sendMaruza'].includes(steep[steep.length - 1])){
        bot.sendMessage(chatId, '–ê—É–¥–∏–æ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä',{
            reply_markup:category
        })
    }
    else if(steep[steep.length - 1] == 'admin'){
        bot.sendMessage(chatId,'–ê–¥–º–∏–Ω —Å–∞—Ö–∏—Ñ–∞—Å–∏',{
            reply_markup:adminmenu
        })
    }
    else if(steep[steep.length - 1] == 'adminVideo'){
        bot.sendMessage(chatId,'–í–∏–¥–µ–æ –º–∞—ä—Ä—É–∑–∞–ª–∞—Ä —Å–∞—Ö–∏—Ñ–∞—Å–∏',{
            reply_markup:videocategory
        })
    }

}

const  render = (arr, cat) => {
    let array = []
    let arr1 = []
    let count = 0
    arr.map((el) => {
        if (el.category == cat){
            let obj = {text: el.title}
            if(count < 2){
                arr1.push(obj)
                count++     
            }else if (count == 2){
                array.push(arr1)
                arr1 = []
                count = 1
                arr1.push(obj)
            }   
        }
    })
    array.push(arr1)
    array.push([{text: 'üîô –û—Ä—Ç–≥–∞'}])
    return array
}
